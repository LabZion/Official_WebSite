#! /bin/bash -e

cd $(dirname $0)/..

source ./auto/set-env-vars

docker pull ${GITHUB_OPS_IMAGE}:latest

echo ">>> Pushed docker image ${GITHUB_OPS_IMAGE} download successful ! ! ! <<<"

source ./auto/set-env-argocd-deployment

REPLACE_MAP="\[image.tag=${TAG}\]"

paras="${USER_AND_REPO} $1 ${VALUE_FILE_PATH} ${REPLACE_MAP}"
echo "参数：>>> ${paras} <<< "

echo "$(docker images)"
echo "$(docker rmi c9b1f86842c3)"
echo "$(docker ps -a)"

result="$(
  docker run -it --rm \
      ${GITHUB_OPS_IMAGE} \
      ${paras} \
      /bin/bash
)"

echo "${result}"

echo ">>> update docker image successful ! <<<"
